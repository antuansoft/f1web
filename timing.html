<!DOCTYPE html>
<html>
 
    <head lang="es">
        <meta charset="UTF-8">
        <title>Timing</title>
        <meta name="Formula uno" content="Formula uno simulaciÃ³n">
        <link rel="stylesheet" type="text/css" href="style.css" />
        <script src="js/json.js"></script>
        <script src="js/utils.js"></script>
        <script>
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            var gp
            var driversDictionary = { };
            var lapChart;
            var lapTimes;
            var lap;
            var timingData = {}

            function readGp(text){
                 var data = JSON.parse(text); //parse JSON
                 console.log(data);
                 document.getElementById("gp").innerHTML += data.gp
            }
            function readDrivers(text){
                 var data = JSON.parse(text); //parse JSON
                 //console.log(data);
                 var driversArray = data.drivers;

                 for (var i = 0; i < driversArray.length; ++i) {
                    var entry = driversArray[i];

                    driversDictionary[entry.number] = entry;
                    //console.log(driversDictionary[entry.number])
                 }
                                  
            }

            function readLapChart(text){
                 lapChart = JSON.parse(text); //parse JSON
                 console.log(lapChart);
                 for (lapindex in lapChart){
                    for (carindex in lapChart[lapindex]){
                        //console.log(lapCharts[lapindex][carindex])
                    }
                 }
            }            

            function readLapTime(text){
                 lapTimes = JSON.parse(text); //parse JSON
                 console.log(lapTimes);
                 for (lapindex in lapTimes){
                    for (timeindex in lapTimes[lapindex]){
                        //console.log(lapTimes[lapindex][timeindex])
                    }
                 }
            }   

            function buildData(){
                console.log("Building data....")
                var lap = 0
                for (lapindex in lapChart){
                    console.log(lapindex)
                    timingData[lap] = []
                    for (carindex in lapChart[lapindex]){
                        var driverData = {}
                        driver = lapChart[lapindex][carindex]
                        //console.log(driver)
                        if (driver!="---"){                        
                            driverData.lap = lap+1
                            driverData.time = lapTimes[driver][lap]
                            driverData.number = driver
                            driverData.name = driversDictionary[driver].name
                            timingData[lap].push(driverData)
                        }
                    }
                    //console.log(lap)
                    lap += 1
                 }
                 console.log(timingData)
                 printTiming(0)
            }

            function printTiming(lap){

                console.log("Printing Timing....")                
                document.getElementById("lap").innerHTML += "Lap:" + lap + " of " + (Object.keys(timingData).length -1) 

                var timinghtml = ""
                timinghtml += "<table  border=\"1\" width=\"20%\" height=\"80%\" align=\"center\">"
                
                for(ltiming in timingData[lap]){
                    timinghtml += "<tr>"
                    timinghtml += "<td>" +  timingData[lap][ltiming].name + " </td>"
                    timinghtml += "<td width=\"10%\">" +  getRaceTime(timingData[lap][ltiming].time) + " </td>"
                    timinghtml += "</tr>"

                }
                
                timinghtml += "</table>"
                document.getElementById("laps").innerHTML = timinghtml

            }
            window.onload = function(){
                gp=urlParams.get('gp')
                loadGps = new Promise((resolve, reject) => {
                    readTextFile("2022/data/gpinfo_"+gp+".json", readGp)
                    resolve('loadGps fired!');
                })
                loadDrivers = new Promise((resolve, reject) => {
                    readTextFile("2022/data/drivers_"+gp+".json", readDrivers)
                    resolve('loadDrivers fired!');
                })
                loadLapchart = new Promise((resolve, reject) => {
                    readTextFile("2022/data/lapchart_"+gp+".json", readLapChart)
                    resolve('loadLapchart fired!');
                })
                loadLaptimes = new Promise((resolve, reject) => {
                    readTextFile("2022/data/laptime_"+gp+".json", readLapTime)
                    resolve('loadLaptimes fired!');
                })
                asyncFunctions=[loadGps,loadDrivers,loadLapchart,loadLaptimes]

                Promise.all(asyncFunctions).then((resp) => {
                    console.log(resp);
                    buildData();
                }).catch((err) => {
                    console.log('something unexpected happened:'+ err);
                })
                
    
            }
        </script>    
    </head>

    <body background="background/xxxx.jpg" class="imagen_background">
        <div w3-include-html="header.html"></div>
        <div class="migas">
            <ul>
                <li><a href="index.html">Portada</a></li>
            </ul>
        </div>
        <p class="titulo3">ANTUAN F1 Lap by lap timing</p>

        <p class="titulo2" id="gp"></p>
        <p class="titulo2" id="lap"></p>
        <div  id="laps"></div>
        
        <div w3-include-html="footer.html"></div>        
    </body>

</html>